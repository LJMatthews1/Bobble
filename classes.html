<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Classes - Bobble</title>
    <script src="js/password-protect.js"></script>
    <link rel="stylesheet" href="css/style.css">
    
    <script type="module">
        // Import the specific functions needed from the CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Your specific Firebase configuration for the Bobble project
        const firebaseConfig = {
            apiKey: "AIzaSyCm470tvi--eWD1LXpzgJpaZoVCM3XPB14",
            authDomain: "bobble-13959.firebaseapp.com",
            projectId: "bobble-13959",
            storageBucket: "bobble-13959.firebasestorage.app",
            messagingSenderId: "164832587163",
            appId: "1:164832587163:web:8ed8f747bac4b5f95cc53e"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            console.log("DEBUG: Firebase initialized successfully on classes.html");

            // --- Navigation Logic ---
            onAuthStateChanged(auth, (user) => {
                const authLink = document.getElementById('auth-link');
                if (user) {
                    console.log("DEBUG: User detected (" + user.email + "). Updating nav to Logout.");
                    authLink.innerHTML = '<a href="#" id="logout-btn">Logout</a>';
                    
                    document.getElementById('logout-btn').addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            console.log("DEBUG: Attempting logout...");
                            await signOut(auth);
                            window.location.reload();
                        } catch (error) {
                            console.error("DEBUG ERROR: Logout failed. Check internet connection.", error);
                        }
                    });
                } else {
                    console.log("DEBUG: No active session. Showing Login link.");
                    authLink.innerHTML = '<a href="login.html">Login</a>';
                }
            });

        } catch (error) {
            console.error("DEBUG ERROR: Firebase failed to load. Check if your apiKey is correct in classes.html.", error);
        }
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="logo" href="index.html">Bobble</a>
            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="classes.html">Classes</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="plans.html">Plans</a></li>
                <li><a href="account.html">Account</a></li>
                <li><a href="meet_the_founders.html">Founders</a></li>
                <li id="auth-link"><a href="login.html">Login</a></li>
            </ul>
        </div>
    </nav>

    <section class="classes-section">
        <div class="container">
            <h2>Available Classes</h2>
            
            <!-- This grid will be populated dynamically -->
            <div class="classes-grid">
                <div class="loading-state" style="text-align: center; padding: 20px;">
                    <p>‚è≥ Loading classes from database...</p>
                </div>
            </div>
        </div>
    </section>

    <div id="footer-wrapper">
        <footer id="footer" class="container">
            <div class="row">
                <div class="col-3 col-6-medium col-12-small">
                    <section class="widget links">
                        <h3>Random Stuff</h3>
                        <ul class="style2">
                            <li><a href="#">Terms & Conditions</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                        </ul>
                    </section>
                </div>
                <div class="col-3 col-6-medium col-12-small">
                    <section class="widget contact last">
                        <h3>Contact Us</h3>
                        <p>1234 London Road<br />London, UK<br />(800) 555-0000</p>
                    </section>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div id="copyright">
                        <ul class="menu">
                            <li>&copy; Bobble 2024-2026. All rights reserved</li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="js/menu.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // 2. CONFIGURATION
        const firebaseConfig = {
          apiKey: "AIzaSyCm470tvi--eWD1LXpzgJpaZoVCM3XPB14",
          authDomain: "bobble-13959.firebaseapp.com",
          databaseURL: "https://bobble-13959-default-rtdb.europe-west1.firebasedatabase.app/",
          projectId: "bobble-13959",
          storageBucket: "bobble-13959.firebasestorage.app",
          messagingSenderId: "164832587163",
          appId: "1:164832587163:web:8ed8f747bac4b5f95cc53e"
        };

        try {
            // 3. INITIALIZATION
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const auth = firebase.auth();
            const classesGrid = document.querySelector('.classes-grid');

            console.log("DEBUG: Firebase scripts loaded and initialized.");

            // 4. AUTHENTICATION (Required if your DB rules are private)
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    console.log("DEBUG: No user, signing in anonymously...");
                    auth.signInAnonymously().catch(err => {
                        console.error("Auth Failed. Check if Anonymous Auth is enabled in Firebase Console.", err);
                        classesGrid.innerHTML = '<p style="color:red;">Authentication Error. Please enable Anonymous login in Firebase.</p>';
                    });
                    return;
                }

                console.log("DEBUG: Authenticated. Fetching from 'categories'...");

                // 5. DATA FETCHING
                // Ensure this matches your top-level node name in Firebase
                database.ref('categories').on('value', (snapshot) => {
                    const categoriesData = snapshot.val();
                    classesGrid.innerHTML = '';

                    if (categoriesData) {
                        Object.entries(categoriesData).forEach(([id, categoryItem]) => {
                            const studioCount = categoryItem.studios ? Object.keys(categoryItem.studios).length : 0;
            
                            // 1. Get image from DB or use a placeholder
                            const imageUrl = categoryItem.image_url || 'https://via.placeholder.com/400x250?text=Bobble+Fitness';
            
                            const categoryCard = document.createElement('div');
                            categoryCard.className = 'class-card';
            
                            // 2. Add the Image div at the top
                            categoryCard.innerHTML = `
                                <div class="category-image-wrapper">
                                    <img src="${imageUrl}" alt="${categoryItem.name}" class="category-card-img">
                                </div>
                                <div class="category-card-body">
                                    <h3>${categoryItem.name || 'Untitled Category'}</h3>
                                    <p><strong>Description:</strong> ${categoryItem.description || 'No description available.'}</p>
                                    <p><strong>Studios:</strong> ${studioCount}</p>
                                    <a href="explore_category.html?category=${id}" class="btn btn-primary">Explore ${categoryItem.name}</a>
                                </div>
                            `;
                            classesGrid.appendChild(categoryCard);
                        });
                        console.log('DEBUG: UI updated with images.');
                    } else {
                        classesGrid.innerHTML = '<p>No categories found.</p>';
                    }
                });
            });

        } catch (initError) {
            console.error('DEBUG: Script crash:', initError);
        }
    </script>
</body>
</html>